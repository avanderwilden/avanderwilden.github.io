# Load Libraries 
library(tidyverse)
library(lubridate)

# Read the csv file, treat empty values or 'null' as NA
df <- read_csv('subscriptions.csv',
               na = c('', 'null')) %>% 
  janitor::clean_names()

# Wrangling
df2 <- df %>% 
  # Convert UNIX timestamps to Dates
  mutate(canceled_at = as.numeric(canceled_at),
         ended_at = as.numeric(ended_at),
         start_date = as.numeric(start_date),
         canceled_at = as_date(as.POSIXct(canceled_at,
                                          origin = '1970-01-01')),
         ended_at = as_date(as.POSIXct(ended_at,
                                       origin = '1970-01-01')),
         start_date = as_date(as.POSIXct(start_date,
                                         origin = '1970-01-01')),
         current_period_end = as_date(as.POSIXct(current_period_end,
                                                  origin = '1970-01-01'))) %>% 
  # Rename the variables to match Stripe Export
  rename(cognito_id = user_id,
         sub_id = id,
         churn_date = ended_at,
         email = latest_invoice_customer_email,
         customer_id = customer,
         plan = plan_interval,
         sub_start_date = start_date,
         expiration_date = current_period_end
         ) %>% 
  # Sort by Sub Start Date
  arrange(sub_start_date) %>% 
  # Set the column order
  relocate(cognito_id, sub_id,customer_id,email,status,
           plan,sub_start_date,churn_date,
           cancel_at_period_end,canceled_at, expiration_date)

# Dynamically grab todays date for the file name
file_name <- paste0('subscriptions_',today(),'.csv') %>% 
  str_replace_all('-','_')

# Write the csv
write_csv(df2,file_name, na = '')




