# Load Libraries 
library(tidyverse)
library(lubridate)

# Read the csv file, treat empty values or 'null' as NA
df <- read_csv('roku_users.csv',
               na = c('', 'null')) %>% 
  janitor::clean_names()


roku_df <- df %>% 
  mutate(subscription_subscription_details_expiration_date = as.numeric(subscription_subscription_details_expiration_date),
         subscription_subscription_details_original_purchase_date = as.numeric(subscription_subscription_details_original_purchase_date),
         subscription_subscription_details_transaction_date = as.numeric(subscription_subscription_details_transaction_date),
         subscription_subscription_details_expiration_date = as_date(as.POSIXct(subscription_subscription_details_expiration_date,
                                                                                origin = '1970-01-01')),
         subscription_subscription_details_original_purchase_date = as_date(as.POSIXct(subscription_subscription_details_original_purchase_date,
                                                                                       origin = '1970-01-01')),
         subscription_subscription_details_transaction_date = as_date(as.POSIXct(subscription_subscription_details_transaction_date,
                                                                                 origin = '1970-01-01'))) %>% 
  rename(cognito_id = id,
         plan = subscription_subscription_details_product_name,
         expiration_date = subscription_subscription_details_expiration_date,
         sub_start_date = subscription_subscription_details_original_purchase_date,
         cancelled = subscription_subscription_details_cancelled,
         sub_id = subscription_subscription_details_original_transaction_id,
         mr_transaction_date = subscription_subscription_details_transaction_date,
         customer_id = roku_customer_id,
         status = subscription_subscription_details_subscription_status) %>% 
  mutate(status = str_to_lower(status),
         status = case_when(
           status == 'active' ~ status,
           status == 'canceled' ~ status,
           TRUE ~ 'active'
         ),
         plan = ifelse(plan == 'NESN 360 (Monthly)', 'month', 'year'),
         churn_date = ifelse(
           cancelled == TRUE & expiration_date < today(),expiration_date,NA
         ),
         churn_date = as_date(churn_date),
         canceled_at = ifelse(
           cancelled == TRUE, mr_transaction_date, NA
         ),
         canceled_at = as_date(canceled_at)) %>% 
  rename(cancel_at_period_end = cancelled) %>% 
  select(-c(mr_transaction_date)) %>% 
  relocate(cognito_id,sub_id,customer_id,email,
           status,plan,sub_start_date, churn_date,
           cancel_at_period_end, canceled_at, expiration_date)
  
  
  
file_name <- paste0('roku_subscriptions_',today(),'.csv') %>% 
  str_replace_all('-','_')

# Write the csv
write_csv(roku_df,file_name, na = '')
  
  
  
  
  
  
  









